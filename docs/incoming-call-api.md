# API –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤

## –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤—Ö–æ–¥—è—â–∏—Ö –∑–≤–æ–Ω–∫–æ–≤ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—ã–π —Ü–∏–∫–ª:
1. –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –∑–≤–æ–Ω–∫–µ –æ—Ç –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —á–µ–∫-–ª–∏—Å—Ç–∞  
3. –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏ –Ω–∞ –∞–Ω–∞–ª–∏–∑
4. –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ n8n –¥–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞
5. –ü–æ–ª—É—á–µ–Ω–∏–µ –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∞–Ω–∞–ª–∏–∑–∞
6. –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º –æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏

## –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### POST /api/incoming-call

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞, —Å–æ–∑–¥–∞–µ—Ç –∑–∞–ø–∏—Å—å –≤ –±–∞–∑–µ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –∞–Ω–∞–ª–∏–∑–∞.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö**:
```json
{
  "call_id": "unique_id",           // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –∑–≤–æ–Ω–∫–∞  
  "phone_number": "+1234567890",   // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞
  "duration": 300,                 // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
  "transcription": "—Ç–µ–∫—Å—Ç —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ –∑–≤–æ–Ω–∫–∞", // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: —Ç–µ–∫—Å—Ç –∑–≤–æ–Ω–∫–∞
  "timestamp": "2025-09-09T10:00:00Z"          // –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ: –≤—Ä–µ–º—è –∑–≤–æ–Ω–∫–∞ –≤ ISO format
}
```

**–ê–ª–≥–æ—Ä–∏—Ç–º –æ–±—Ä–∞–±–æ—Ç–∫–∏**:
1. –°–æ–∑–¥–∞–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–ø–∏—Å–∏ Call –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. –ü–æ–∏—Å–∫ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –¥–µ—Ñ–æ–ª—Ç–Ω–æ–≥–æ —á–µ–∫-–ª–∏—Å—Ç–∞ (isActive: true, isDefault: true)
3. –°–æ–∑–¥–∞–Ω–∏–µ CallReview –∑–∞–ø–∏—Å–∏ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º PENDING
4. –û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ n8n –¥–ª—è AI-–∞–Ω–∞–ª–∏–∑–∞
5. –û—Ç–ø—Ä–∞–≤–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞ –≤–Ω–µ—à–Ω–∏–π webhook

**–û—Ç–≤–µ—Ç –ø—Ä–∏ —É—Å–ø–µ—Ö–µ (201)**:
```json
{
  "success": true,
  "call": {
    "id": "test-incoming-20250909-120203",
    "dealId": "UNKNOWN",  
    "createdAt": "2025-09-09T12:02:03.000Z",
    "employeeName": "–¢–µ—Å—Ç –°–æ—Ç—Ä—É–¥–Ω–∏–∫",
    "managerName": "–¢–µ—Å—Ç –ú–µ–Ω–µ–¥–∂–µ—Ä", 
    "payload": {
      "callType": "inbound",
      "duration": 300,
      "phoneNumber": "+1234567890"
    },
    "callText": "–¢–µ—Å—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫...",
    "reviews": [...]
  },
  "review": {
    "id": "cmfcbnt170001v8r49wjukscg",
    "callId": "test-incoming-20250909-120203", 
    "templateId": "default-checklist",
    "status": "SUCCESS|FAILED|PENDING",
    "createdAt": "2025-09-09T09:02:05.753Z",
    "template": {
      "title": "–ë–∞–∑–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞ –∑–≤–æ–Ω–∫–∞"
    }
  }
}
```

### POST /api/incoming-call/results

**–û–ø–∏—Å–∞–Ω–∏–µ**: –ü–æ–ª—É—á–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç n8n –∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç CallReview, –∑–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö**:
```json
{
  "reviewId": "cmfcbnt170001v8r49wjukscg",  // ID —Å–æ–∑–¥–∞–Ω–Ω–æ–π —Ä–∞–Ω–µ–µ CallReview –∑–∞–ø–∏—Å–∏
  "status": "success",                      // "success" | "failed"  
  "analysisResults": {                      // –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –æ—Ç AI
    "scores": [
      {
        "itemTitle": "–ü–æ–∑–¥–æ—Ä–æ–≤–∞–ª—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º",
        "evaluationType": "YES_NO",
        "result": "YES",
        "confidence": 0.95
      },
      {
        "itemTitle": "–í—ã—è—Å–Ω–∏–ª –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –∫–ª–∏–µ–Ω—Ç–∞", 
        "evaluationType": "SCALE_1_10",
        "score": 8,
        "confidence": 0.87
      }
    ],
    "overallScore": 7.5,
    "summary": "–ó–≤–æ–Ω–æ–∫ –ø—Ä–æ—à–µ–ª —Ö–æ—Ä–æ—à–æ, –º–µ–Ω–µ–¥–∂–µ—Ä —Å–ª–µ–¥–æ–≤–∞–ª —Å–∫—Ä–∏–ø—Ç—É"
  }
}
```

**–û—Ç–≤–µ—Ç –ø—Ä–∏ —É—Å–ø–µ—Ö–µ (200)**:
```json
{
  "success": true,
  "message": "–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã",
  "review": {
    "id": "cmfcbnt170001v8r49wjukscg",
    "status": "SUCCESS",
    "analysisResults": {...},
    "completedAt": "2025-09-09T12:05:30.000Z",
    "call": {...},
    "template": {...}
  }
}
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å n8n

### –û—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ –∞–Ω–∞–ª–∏–∑

**URL**: –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `N8N_WEBHOOK_URL`  
**–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é**: `https://miquenaluekos.beget.app/webhook/callai`

**Payload –¥–ª—è n8n**:
```json
{
  "id": "call-id",
  "text": "—Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞ –∑–≤–æ–Ω–∫–∞",
  "checklist": [
    {
      "title": "–ü–æ–∑–¥–æ—Ä–æ–≤–∞–ª—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º",
      "description": "–ú–µ–Ω–µ–¥–∂–µ—Ä –≤–µ–∂–ª–∏–≤–æ –ø–æ–∑–¥–æ—Ä–æ–≤–∞–ª—Å—è...", 
      "evaluationType": "YES_NO"
    }
  ],
  "reviewId": "review-id-–¥–ª—è-–æ–±—Ä–∞—Ç–Ω–æ–π-—Å–≤—è–∑–∏"
}
```

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

n8n –¥–æ–ª–∂–µ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞ –Ω–∞ `/api/incoming-call/results` (—Å–º. –≤—ã—à–µ).

## –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤–Ω–µ—à–Ω–∏—Ö —Å–∏—Å—Ç–µ–º

–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∞–Ω–∞–ª–∏–∑–∞ —Å–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–∞:  
`https://miquenaluekos.beget.app/webhook/callai`

**Payload —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è**:
```json
{
  "type": "analysis_completed",
  "callId": "call-id",
  "reviewId": "review-id", 
  "status": "SUCCESS|FAILED",
  "analysisResults": {...},
  "call": {
    "id": "call-id",
    "dealId": "DEAL-001",
    "employeeName": "–ò–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞",
    "managerName": "–ò–º—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞", 
    "createdAt": "2025-09-09T10:00:00Z",
    "payload": {...}
  },
  "template": {
    "title": "–ù–∞–∑–≤–∞–Ω–∏–µ —á–µ–∫-–ª–∏—Å—Ç–∞",
    "items": [...]
  },
  "completedAt": "2025-09-09T12:05:30.000Z"
}
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

1. **–ê–∫—Ç–∏–≤–Ω—ã–π –¥–µ—Ñ–æ–ª—Ç–Ω—ã–π —á–µ–∫-–ª–∏—Å—Ç**: –í —Å–∏—Å—Ç–µ–º–µ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω —á–µ–∫-–ª–∏—Å—Ç —Å `isActive: true` –∏ `isDefault: true`
2. **–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è**:
   - `N8N_WEBHOOK_URL` - URL –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ n8n
   - `DATABASE_URL` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö PostgreSQL
3. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö**: –¢—Ä–µ–±—É—é—Ç—Å—è —Ç–∞–±–ª–∏—Ü—ã `calls`, `call_reviews`, `checklist_templates`, `checklist_items`

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –¢–µ—Å—Ç —Å–æ–∑–¥–∞–Ω–∏—è –≤—Ö–æ–¥—è—â–µ–≥–æ –∑–≤–æ–Ω–∫–∞
curl -X POST http://localhost:3000/api/incoming-call \
  -H "Content-Type: application/json" \
  -d '{
    "call_id": "test-incoming-123",
    "phone_number": "+1234567890", 
    "duration": 300,
    "transcription": "–¢–µ—Å—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏",
    "timestamp": "2025-09-09T12:00:00Z"
  }'

# –¢–µ—Å—Ç –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ (–∑–∞–º–µ–Ω–∏—Ç—å reviewId –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π)
curl -X POST http://localhost:3000/api/incoming-call/results \
  -H "Content-Type: application/json" \
  -d '{
    "reviewId": "cmfcbnt170001v8r49wjukscg",
    "status": "success",
    "analysisResults": {
      "scores": [
        {
          "itemTitle": "–ü–æ–∑–¥–æ—Ä–æ–≤–∞–ª—Å—è —Å –∫–ª–∏–µ–Ω—Ç–æ–º",
          "evaluationType": "YES_NO", 
          "result": "YES",
          "confidence": 0.95
        }
      ],
      "overallScore": 8.5
    }
  }'
```

## –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –≤ –∫–æ–Ω—Å–æ–ª—å —Å–µ—Ä–≤–µ—Ä–∞ —Å –ø—Ä–µ—Ñ–∏–∫—Å–∞–º–∏:
- `üì•` - –ø–æ–ª—É—á–µ–Ω–∏–µ –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö  
- `‚úÖ` - —É—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- `üì§` - –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–Ω–µ—à–Ω–∏—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- `‚ö†Ô∏è` - –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- `‚ùå` - –æ—à–∏–±–∫–∏
